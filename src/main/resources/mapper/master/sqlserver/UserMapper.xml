<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nssol.dao.master.UserDao">
	<resultMap id="BaseResultMap" type="com.nssol.model.UserModel">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jan 15 
			14:03:52 CST 2018. -->
		<id column="userId" jdbcType="VARCHAR" property="userId" />
		<result column="userName" jdbcType="VARCHAR" property="userName" />
		<result column="password" jdbcType="VARCHAR" property="password" />
		<result column="realName" jdbcType="VARCHAR" property="realName" />
		<result column="FK_RoleCode" jdbcType="VARCHAR" property="fkRoleCode" />
		<result column="Role_Name" jdbcType="VARCHAR" property="roleName" />
		<result column="sex" jdbcType="INTEGER" property="sex" />
		<result column="tel" jdbcType="VARCHAR" property="tel" />
		<result column="iCCard" jdbcType="VARCHAR" property="iCCard" />
		<result column="isDel" jdbcType="INTEGER" property="isDel" />
		<result column="creater" jdbcType="VARCHAR" property="creater" />
		<result column="createTime" jdbcType="VARCHAR" property="createTime" />
		<result column="modifyer" jdbcType="VARCHAR" property="modifyer" />
		<result column="modifyTime" jdbcType="VARCHAR" property="modifyTime" />
		<result column="deleter" jdbcType="VARCHAR" property="deleter" />
		<result column="deleteTime" jdbcType="VARCHAR" property="deleteTime" />
	</resultMap>
	
	<sql id="getUserCondition_old">
		<where>
			1=1 and IsDel=0 
			 <if test="userId != null and userId != ''">
                 AND user_id LIKE CONCAT('%',#{userId},'%')
             </if>
             <if test="userName != null and userName != ''">
                 AND user_name LIKE CONCAT('%',#{userName},'%')
             </if>
             <if test="password != null and password != ''">
                 AND password=#{password}
             </if>
		</where>
	</sql>
	
	<select id="selectByCriteria" parameterType="com.nssol.model.UserModel"
		resultMap="BaseResultMap">
		SELECT
			*
		FROM 
			T_USER
		<include refid="getUserCondition_old"/>
	</select>

	<insert id="insert" parameterType="com.nssol.model.UserModel">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jan 15 
			14:03:52 CST 2018. -->
		insert into public.users (user_id, user_name, password)
		values
		(#{userId,jdbcType=VARCHAR},
		#{userName,jdbcType=VARCHAR},
		#{password,jdbcType=VARCHAR})
	</insert>

	<select id="selectUserByIDCard" parameterType="com.nssol.model.UserModel"
		resultMap="BaseResultMap">
		SELECT
			*
		FROM 
			T_USER
		where ICCard=#{iCCard} and IsDel=0
	</select>
	
	<!-- 获取list数据  -->
	<select id="getUserListPage" parameterType="com.nssol.model.UserModel" resultMap="BaseResultMap">
		SELECT A.*,B.Role_Name
		FROM (select *,ROW_NUMBER() OVER(ORDER BY CreateTime desc) as counts from T_USER) A
		LEFT JOIN Role_Info B ON A.FK_RoleCode = B.Role_Code
		<include refid="getUserCondition"/>
	</select>
	
	<!-- 获取list数量  -->
	<select id="getUserTotal" parameterType="com.nssol.model.UserModel" resultType="java.lang.Integer">
		SELECT Count(1)
		FROM T_USER
		WHERE IsDel=0 
	          <if test="userName != null and userName != ''">
	              AND UserName LIKE CONCAT('%',#{userName},'%')
	          </if>
	</select>
	
	<sql id="getUserCondition">
		<where>
			 A.IsDel=0 
             <if test="userName != null and userName != ''">
                 AND A.UserName LIKE CONCAT('%',#{userName},'%')
             </if>
             AND A.counts between #{offset} + 1 and #{limit} * #{page}
             <!-- 		LIMIT #{offset},#{limit} -->
		</where>
	</sql>

	<!-- 获取角色列表  -->
	<select id="getRoleList" resultType="com.nssol.model.Role_Info">
		SELECT Role_Code roleCode,
			   Role_Name roleName
		FROM Role_Info
		WHERE IsDel=0 
	</select>


	<!-- 判断用户重复 -->
	<select id="selectUser" parameterType="com.nssol.model.UserModel" resultType="java.lang.Integer">
		SELECT Count(1)
		FROM T_USER
		WHERE IsDel=0 
          <if test="userName != null and userName != ''">
              AND UserName = #{userName}
          </if>
          AND UserId != #{userId}
	</select>

	<!-- 获取编辑的用户数据 -->
	<select id="selectUserEdit" parameterType="com.nssol.model.UserModel" resultMap="BaseResultMap">
		SELECT *
		FROM T_USER
		WHERE IsDel=0 
              AND UserId = #{userId}
	</select>


	
	<!-- 重置用户密码 -->
	<update id="restPas"  parameterType = "java.util.List">
		<foreach collection="list" item="item" index="index" open="" close="" separator=";">
	        UPDATE T_USER
	        <set>
	          	Password = 'e10adc3949ba59abbe56e057f20f883e'
	        </set>
	        WHERE UserId = #{item.userId}
	    </foreach>
	</update>
	
	<!-- 修改用户密码 -->
	<update id="editPas" parameterType="String">
        UPDATE T_USER
        <set>
          	Password = #{newPas}
        </set>
        WHERE UserId = #{userId} 
        AND Password = #{oldPas}
        AND IsDel = 0
	</update>

    <!-- 获取对应用户信息 -->
	<select id="findByUserNameAndPassword" parameterType="com.nssol.model.UserModel" resultMap="BaseResultMap">
		SELECT *
		FROM T_USER
		WHERE IsDel=0 
              AND UserName = #{userName}
              AND Password=#{password}
	</select>

	<!-- 修改用户密码 -->
	<update id="restPasById" parameterType="String">
		UPDATE T_USER
		<set>
			Password = #{password}
		</set>
		WHERE UserId = #{userId}
		AND IsDel = 0
	</update>

	<!-- 新增用户  -->
	<insert id="insertUser" parameterType="com.nssol.web.system.model.UserInfo">
		INSERT into T_USER (UserId, UserName,  Password,Sex, Tel,ICCard,IsDel,  Creater, CreateTime, Modifyer, ModifyTime,Deleter,DeleteTime,RealName,FK_RoleCode)
		VALUES
		(#{id},
		#{account},
		#{password},
		#{sex},
		#{phone},
		#{iCCard},
		#{isDel},
		#{creater},
		#{createTime},
		#{modifyer},
		#{modifyTime},
		#{deleter},
		#{deleteTime},
		#{realName},
		#{roleCode})
	</insert>

	<!-- 更新用户数据 -->
	<update id="updateUser" parameterType="com.nssol.web.system.model.UserInfo">
		UPDATE T_USER
		SET
		UserName = #{account},
		Password = #{password},
		Sex = #{sex},
		Tel = #{phone},
		ICCard = #{iCCard},
		IsDel = #{isDel},
		Creater = #{creater},
		CreateTime = #{createTime},
		Modifyer = #{modifyer},
		ModifyTime = #{modifyTime},
		Deleter = #{deleter},
		DeleteTime = #{deleteTime},
		RealName = #{realName},
		FK_RoleCode = #{roleCode}
		WHERE IsDel = 0
		AND userId=#{id}
	</update>

	<delete id="deleteUserRoleById" >
		DELETE
		FROM M_USER_ROLE
		WHERE userId = #{userId}
	</delete>
	<insert id="insertUserRole" parameterType="java.util.List">
		INSERT INTO  M_USER_ROLE
		(
		UserId,
		RoleId
		)VALUES
		<foreach collection="userRoleList" index="index" item="userRoleInfo" separator=","  >
			(
			#{userRoleInfo.userId},
			#{userRoleInfo.roleId}
			)
		</foreach>
	</insert>

	<delete id="delUser">
		DELETE
		FROM T_USER
		WHERE
		userId = #{userId}
	</delete>

	<delete id="delUserRole">
		DELETE a
		FROM M_USER_ROLE  a
		LEFT JOIN T_USER b
		ON a.UserId = b.UserId
		WHERE b.UserId is null
	</delete>
	<!-- 获取对应用户信息 -->
	<select id="findUser" parameterType="com.nssol.web.system.controller.user.UserRequest"
			resultType="com.nssol.web.system.model.UserInfo">
		SELECT
		UserId AS id,
		UserName AS account,
		Password AS password,
		Sex AS sex,
		Tel AS phone,
		ICCard AS iCCard,
		IsDel AS isDel,
		Creater AS creater,
		CreateTime AS createTime,
		Modifyer AS modifyer,
		ModifyTime AS modifyTime,
		Deleter AS deleter,
		DeleteTime AS deleteTime,
		RealName AS realName,
		FK_RoleCode AS roleCode
		FROM T_USER
		WHERE
		1=1
		<if test="account != null and account != ''">
			AND UserName LIKE CONCAT('%',#{account},'%')
		</if>
	</select>

	<select id="findRoleList"
			resultType="com.nssol.web.system.model.RoleInfo">
		SELECT
		id AS id,
		rolecode AS roleCode,
		rolename AS roleName,
		RoleDesc AS roleDesc,
		ParentId AS parentId,
		creater AS creater,
		isdel AS isDel,
		createtime AS createTime,
		modifytime AS modifyTime,
		modifyer AS modifyer
		FROM  M_USER_ROLE mur INNER JOIN M_ROLE mr
		ON mur.RoleId = mr.id
		WHERE mur.UserId = #{userId}
	</select>

	<!-- 获取对应用户信息 -->
	<select id="findUserByName"
			resultType="com.nssol.web.system.model.UserInfo">
		SELECT
		UserId AS id,
		UserName AS account,
		Password AS password,
		Sex AS sex,
		Tel AS phone,
		ICCard AS iCCard,
		IsDel AS isDel,
		Creater AS creater,
		CreateTime AS createTime,
		Modifyer AS modifyer,
		ModifyTime AS modifyTime,
		Deleter AS deleter,
		DeleteTime AS deleteTime,
		RealName AS realName,
		FK_RoleCode AS roleCode
		FROM T_USER
		WHERE
			 UserName = #{userName}

	</select>

</mapper>